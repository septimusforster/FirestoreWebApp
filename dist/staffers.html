<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staffers</title>
    <style>
        :root{
            --transition-all:.15s ease;
        }
        html, body, * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }
        body {
            color: #555;
        }
        button{
            outline:none;
            border:0;
            cursor:pointer;
        }
        h4, b{
            font-weight:500;
        }
        svg{
            height:1rem;
            width:1rem;
        }
        main {
            height:80vh;
            min-width:768px;
            max-width:1200px;
            margin:10vh auto;
            box-shadow:0 5px 14px #ccc;
            border-radius:14px;
            overflow:hidden;
            overflow-y:auto;
            position:relative;
        }
        table {
            border-collapse: collapse;
            width:100%;
        }
        thead {
            background-color:rgb(250, 250, 250);
            position:sticky;
            top:0;
            z-index:3;
        }
        tbody{
            color:#777;
        }
        tr:not(:last-child){
            border-bottom:1px solid #eee;
        }
        th {
            text-align: left;
            font-weight:500;
        }
        th, td {
            padding:1rem 2rem;
            position:relative;
        }
        td:nth-child(2),
        td:nth-child(3){
            padding:.5rem;
        }
        td:nth-child(n + 5),
        td:nth-child(5){
            font-size: .8rem;
        }
        td:nth-child(5){
            font-weight:500;
        }
        td > p{
            width:140px;
            font-size:.8rem;
            margin-right:5px;
        }
        i.btn{
            display:flex;
            align-items:center;
            justify-content:center;
            transition:var(--transition-all);
            height:2rem;
            width:2rem;
            cursor:pointer; 
        }
        [disabled],
        i.btn > *{
            pointer-events:none;
        }
        [data-eye]{
            border-radius:50%;
            position:absolute;
            right:0;
            top:50%;
            transform:translateY(-50%);
        }
        td:hover [data-eye],
        td:hover [data-trash],
        [data-eye].on{
            background:#f3f3f3;
        }
        [data-trash]{
            box-shadow:0 4px 14px #eee;
            border-radius:5px;
        }
        ::backdrop{
            background:#3337;
        }
        [popover]{
            background:transparent;
            left:0;
            top:0;
            height:100%;
            width:100%;
            outline:none;
            border:0;
        }
        [popover] #note{
            position:absolute;
            top:50%;
            left:50%;
            transform:translate(-50%, -50%);
            width:300px;
            border-radius:14px;
            background:#fff;
            overflow:hidden;
        }
        [popover] #note > *:not([popovertarget]){
            padding:1rem;
        }
        [popover] #note p{
            padding:2rem;
            color:#444;
        }
        [popovertarget]{
            position:absolute;
            right:.8rem;
            top:.8rem;
            height:1.7rem;
            width:1.7rem;
            border-radius:50%;
            display:flex;
            align-items:center;
            justify-content:center;
        }
        [popovertarget] > svg{
            scale:1.3;
        }
        #del-btn {
            display:block;
            color: #e35;
            font-weight: 500;
            width: 70%;
            margin: 1rem auto;
            border-radius: 24px;
            font-size: 1rem;
            background: #e351;
            padding: .8rem !important;
            transition:var(--transition-all);
            position:relative;
        }
        #del-btn:hover{
            background:#e352;
        }
        #spinner{
            position:absolute;
            left:50%;
            top:50%;
            transform:translate(-50%, -50%);
            height:1.5rem;
            width:1.5rem;
            border-radius:50%;
            border:3px solid transparent;
            border-color: #444 #444 #444 #4443;
        }
        footer{
            position:fixed;
            width:100%;
            left:50%;
            bottom:4vh;
            transform:translateX(-50%);
            overflow:hidden;
        }
        #notf{
            width:320px;
            background:#444;
            color:#fff;
            display:flex;
            align-items:center;
            padding:.3rem 1rem;
            border-radius:4px;
        }
        #notf.err{
            border:2px solid #e35;
        }
        #notf span{
            max-width:64%;
            text-wrap:nowrap;
            text-overflow:ellipsis;
            overflow:hidden;
        }
        #notf i.btn{
            margin-left:auto;
            height:2.5rem;
            width:2.5rem;
            background:#555;
            border-radius:50%;
        }
        #notf i.btn svg{
            scale:1.3;
        }
        #obs{
            min-height:70px;
            background:none;
            pointer-events:none;
            position:relative;
        }
    </style>
</head>
<body>
    <svg style="display:none;" id="sprite" xmlns="http://www.w3.org/2000/svg">
        <symbol id="eye-open" class="ionicon" viewBox="0 0 512 512">
            <path d="M255.66 112c-77.94 0-157.89 45.11-220.83 135.33a16 16 0 00-.27 17.77C82.92 340.8 161.8 400 255.66 400c92.84 0 173.34-59.38 221.79-135.25a16.14 16.14 0 000-17.47C428.89 172.28 347.8 112 255.66 112z" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="32"/><circle cx="256" cy="256" r="80" fill="none" stroke="currentColor" stroke-miterlimit="10" stroke-width="32"/>
        </symbol>
        <symbol id="eye-closed" class="ionicon" viewBox="0 0 512 512" fill="#888" stroke="currentColor">
            <path d="M432 448a15.92 15.92 0 01-11.31-4.69l-352-352a16 16 0 0122.62-22.62l352 352A16 16 0 01432 448zM255.66 384c-41.49 0-81.5-12.28-118.92-36.5-34.07-22-64.74-53.51-88.7-91v-.08c19.94-28.57 41.78-52.73 65.24-72.21a2 2 0 00.14-2.94L93.5 161.38a2 2 0 00-2.71-.12c-24.92 21-48.05 46.76-69.08 76.92a31.92 31.92 0 00-.64 35.54c26.41 41.33 60.4 76.14 98.28 100.65C162 402 207.9 416 255.66 416a239.13 239.13 0 0075.8-12.58 2 2 0 00.77-3.31l-21.58-21.58a4 4 0 00-3.83-1 204.8 204.8 0 01-51.16 6.47zM490.84 238.6c-26.46-40.92-60.79-75.68-99.27-100.53C349 110.55 302 96 255.66 96a227.34 227.34 0 00-74.89 12.83 2 2 0 00-.75 3.31l21.55 21.55a4 4 0 003.88 1 192.82 192.82 0 0150.21-6.69c40.69 0 80.58 12.43 118.55 37 34.71 22.4 65.74 53.88 89.76 91a.13.13 0 010 .16 310.72 310.72 0 01-64.12 72.73 2 2 0 00-.15 2.95l19.9 19.89a2 2 0 002.7.13 343.49 343.49 0 0068.64-78.48 32.2 32.2 0 00-.1-34.78z"/><path d="M256 160a95.88 95.88 0 00-21.37 2.4 2 2 0 00-1 3.38l112.59 112.56a2 2 0 003.38-1A96 96 0 00256 160zM165.78 233.66a2 2 0 00-3.38 1 96 96 0 00115 115 2 2 0 001-3.38z"/>
        </symbol>
        <symbol id="close" class="ionicon" viewBox="0 0 512 512">
            <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="32" d="M368 368L144 144M368 144L144 368"/>
        </symbol>
        <symbol id="trash" class="ionicon" viewBox="0 0 512 512">
            <path d="M112 112l20 320c.95 18.49 14.4 32 32 32h184c17.67 0 30.87-13.51 32-32l20-320" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="32"/><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="32" d="M80 112h352"/><path d="M192 112V72h0a23.93 23.93 0 0124-24h80a23.93 23.93 0 0124 24h0v40M256 176v224M184 176l8 224M328 176l-8 224" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="32"/>
        </symbol>
    </svg>
    <header></header>
    <main>
        <table>
            <thead>
                <tr>
                    <th>&numero;</th>
                    <th>Name</th>
                    <th title="Username">Username</th>
                    <th title="Password">Password</th>
                    <th title="Classes Taught">Classes</th>
                    <th colspan="2" title="Form Teacher">Form Teacher</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
        <div id="obs" style="display:none;"></div>
    </main>
    <div popover="manual" id="trash-user">
        <div id="note">
            <h4>Delete permanently</h4>
            <p>CAUTION: This will delete <b></b> account details, forever.</p>
            <button type="button" popovertarget="trash-user" popovertargetaction="hide">
                <svg><use href="#close"></use></svg>
            </button>
            <button type="button" id="del-btn">DELETE</button>
        </div>
    </div>
    <footer>
    </footer>
    <script type="module">
        import { initializeApp, deleteApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getFirestore, collection, doc, deleteDoc, getDocs, orderBy, startAfter, limit, where, query } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
        const fbconfig = {    
            "apiKey": "AIzaSyB1FJnKHGt3Ch1KGFuZz_UtZm1EH811NEU",
            "authDomain": "fir-pro-152a1.firebaseapp.com",
            "projectId": "fir-pro-152a1",
            "storageBucket": "fir-pro-152a1.appspot.com",
            "messagingSenderId": "158660765747",
            "appId": "1:158660765747:web:bd2b4358cc5fc9067ddb46"
        }
        let app = initializeApp(fbconfig);
        let db = getFirestore();
        document.addEventListener('DOMContentLoaded', async e => {
            let tr = 0;
            const tbody = document.querySelector('table tbody');
            const main = document.querySelector('main');
            const obsElem = document.getElementById('obs');
            const spinnerKeyframe = [
                {transform: "translate(-50%, -50%) rotate(0deg)"},
                {transform: "translate(-50%, -50%) rotate(360deg)"},
            ];
            const spinnerTimeline = {
                duration: 1000,
                easing: "linear",
                iterations: 'Infinity'
            }
            const notfKeyframe = [
                {opacity: "0", transform: "translateX(.5rem)"},
                {opacity: "1", transform: "translateX(1.5rem)"},
            ];
            const notfTimeline = {
                duration: 100,
                easing: "linear",
                fill: "forwards",
                // iterations: ""
            }
            const tableRowKeyframe = [
                {opacity:1, transform: "translateX(0px)"},
                {opacity:0, transform: "translateX(10px)"}
            ];
            const tableRowTimeline = {
                duration: 200,
                easing: "linear",
                fill: "forwards"
            };

            main.insertAdjacentHTML('beforeend', '<div id="spinner"></div>');
            main.querySelector('#spinner').animate(spinnerKeyframe, spinnerTimeline);
            //set up Intersection Observer
            const observerOption = {
                root: main,
                rootMargin: '0px',
                threshold: 0.5
            }
            const observer = new IntersectionObserver(handleIntersection, observerOption);
            observer.observe(obsElem);

            let lastSnapshot, datas = [];
            async function fetchData(){
                let udata;
                if(lastSnapshot){
                    udata = await getDocs(query(collection(db, 'staffCollection'), limit(30), orderBy('fullName'), startAfter(lastSnapshot)));
                }else{
                    udata = await getDocs(query(collection(db, 'staffCollection'), limit(30), orderBy('fullName')));
                    obsElem.removeAttribute('style');
                }
                if(udata.docs.length){
                    lastSnapshot = udata.docs[udata.docs.length - 1];
                    udata.docs.forEach(dc => {
                        datas.push(Object.assign({id: dc.id}, dc.data()));
                    })
                    insertData(udata);
                }else{
                    notf("No more record found.", true);
                    // obsElem.remove();
                    observer.unobserve(obsElem);
                }
            }
            await fetchData();
            main.querySelector('#spinner').remove();

            function handleIntersection(entries, observer){
                entries.forEach(async entry => {
                    if(entry.isIntersecting){
                        console.log("Target is now visible to fetch.");
                        entry.target.innerHTML = '<div id="spinner"></div>';
                        entry.target.querySelector('#spinner').animate(spinnerKeyframe, spinnerTimeline);
                        await fetchData();
                        entry.target.innerHTML = '';
                    }
                })
            }
            function insertData(data){
                data.docs.forEach(val => {
                    tr++;
                    tbody.insertAdjacentHTML('beforeend', `
                        <tr id="${val.id}">
                            <td>${tr}</td>
                            <td>${val.data().fullName}</td>
                            <td>${val.data().username}</td>
                            <td>
                                <p>${'&ast;'.repeat(val.data().password.length)}</p>
                                <i class="btn" data-eye>
                                    <svg><use href="#eye-closed"></use></svg>
                                </i>
                            </td>
                            <td>${val.data().classroomsTaught}</td>
                            <td>${val.data()?.masterOfForm ? Object.entries(val.data().masterOfForm)[0].join(", ") : 'No'}
                            <td>
                                <i class="btn" data-trash>
                                    <svg><use href="#trash"></use></svg>
                                </i>
                            </td>
                        </tr>
                    `);
                });
            }
            // trash listener
            const trashPopover = document.getElementById('trash-user');
            let uid, usn;
            // trashPopover.onclick = function(e){
            //     console.log(e.target.id, this.id);
            // }
            tbody.addEventListener('click', e => {
                if(e.target.hasAttribute('data-trash')){ // trashing user
                    uid = e.target.closest('tr').id;
                    usn = e.target.closest('tr').querySelector('td:nth-child(2)').textContent;
                    trashPopover.querySelector('b').textContent = usn;
                    trashPopover.showPopover();
                    // console.log(uid)
                }else if(e.target.hasAttribute('data-eye')){ // viewing pwd
                    const tr = e.target.closest('tr');
                    const passwordSeen = tr.classList.toggle('on');
                    const pwd = datas.find(({id}) => id == tr.id).password;

                    if(passwordSeen){
                        e.target.querySelector('use').setAttribute('href', '#eye-open');
                        e.target.closest('td').querySelector('p').innerHTML = pwd;
                    }else{
                        e.target.querySelector('use').setAttribute('href', '#eye-closed');
                        e.target.closest('td').querySelector('p').innerHTML = '&ast;'.repeat(pwd.length);
                    }
                }
            });
            // del-btn handler
            const footer = document.querySelector('footer');
            const delBtn = document.getElementById('del-btn');
            delBtn.addEventListener('click', async (e) => {
                delBtn.disabled = true;
                const delTxt = delBtn.textContent;
                delBtn.innerHTML = '<div id="spinner"></div>';
                delBtn.querySelector('#spinner').animate(spinnerKeyframe, spinnerTimeline);

                // delete user
                try{
                    // const userRef = doc(db, 'staffCollection', uid);
                    // await deleteDoc(userRef);
                    // animate tableRow removal
                    const tRow = document.getElementById(`${uid}`);
                    tRow.animate(tableRowKeyframe, tableRowTimeline);
                    const timeoutID = setTimeout(() => {
                        tr--;
                        tRow.remove();
                        const idx = datas.findIndex(x => x.id == uid);
                        for(let i = idx + 1; i <= tr; i++){
                            tbody.querySelector(`tr:nth-child(${i}) > td:nth-child(1)`).textContent = i;
                        }
                        datas.splice(idx,1);
                    }, 1000);

                    notf(`${usn}`);
                } catch (err) {
                    console.log(err);
                    notf(`Error deleting ${usn}`, true);
                } finally{
                    trashPopover.hidePopover();
                    delBtn.innerHTML = delTxt;
                    delBtn.disabled = false;
                }
            });

            // notf handler
            function notf(msg, hasError = false){
                footer.innerHTML = `
                    <div id="notf" ${hasError ? 'class="err"' : null}">
                        ${hasError ? `<span>${msg}</span>` : `<span>${msg}</span>&nbsp;deleted`}
                        <i class="btn" onclick="this.closest('#notf').remove();">
                            <svg><use href="#close"></use></svg>
                        </i>
                    </div>
                `;
                footer.querySelector('#notf').animate(notfKeyframe, notfTimeline);
            }
        })
    </script>
</body>
</html>